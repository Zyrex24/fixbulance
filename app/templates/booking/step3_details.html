{% extends "base.html" %}

{% block title %}Emergency Repair Details - Step 3: Device Information - Fixbulance{% endblock %}

{% block styles %}
<style>
    .booking-container {
        min-height: 70vh;
        background: linear-gradient(135deg, rgba(227, 232, 216, 0.1) 0%, rgba(30, 58, 95, 0.05) 100%);
        padding: 3rem 0;
    }
    
    .booking-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
    }
    
    .booking-header {
        background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
        color: var(--white);
        padding: 2rem;
        text-align: center;
        border: none;
    }
    
    .booking-header h4 {
        color: var(--white);
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .emergency-badge {
        background-color: var(--red);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    
    .progress-bar-container {
        margin: 2rem 0;
    }
    
    .custom-progress {
        height: 8px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .custom-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--red), #ff4757);
        width: 50%; /* 3/6 steps */
        transition: width 0.3s ease;
    }
    
    .selections-summary {
        background: linear-gradient(135deg, #10b981, #059669);
        color: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        padding: 2.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--dark-navy);
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--navy);
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .section-header {
        color: var(--navy);
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light-gray);
    }
    
    .emergency-info {
        background: rgba(220, 38, 38, 0.1);
        border-left: 4px solid var(--red);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .step-navigation {
        padding: 1.5rem 2.5rem;
        background: var(--light-gray);
        border-top: 1px solid #e2e8f0;
    }
    
    .photo-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .photo-upload-area:hover {
        border-color: var(--navy);
        background: rgba(30, 58, 95, 0.05);
    }
    
    .photo-upload-area.dragover {
        border-color: var(--red);
        background: rgba(220, 38, 38, 0.05);
    }
    
    /* Dynamic Pricing Styles */
    .pricing-card {
        background: var(--white);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .pricing-summary {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e2e8f0;
    }
    
    .price-breakdown {
        font-size: 0.95rem;
    }
    
    .service-options {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .service-option {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .service-option:hover {
        border-color: var(--navy);
        background: rgba(30, 58, 95, 0.05);
    }
    
    .service-option.selected {
        border-color: var(--navy);
        background: rgba(30, 58, 95, 0.1);
    }
    
    .parts-option {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .parts-option:hover {
        border-color: var(--medium-gray);
        background: var(--light-gray);
    }
    
    .parts-option.selected {
        border-color: var(--navy);
        background: rgba(30, 58, 95, 0.1);
    }
    
    .parts-badge {
        background: var(--navy);
        color: var(--white);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .parts-badge.afm {
        background: #f59e0b;
    }
    
    @media (max-width: 768px) {
        .booking-container {
            padding: 1rem 0;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .step-navigation {
            padding: 1rem 1.5rem;
        }
        
        .pricing-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="booking-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card booking-card">
                    <div class="card-header booking-header">
                        <div class="emergency-badge">
                            <i class="fas fa-ambulance me-1"></i>
                            Emergency Diagnostic Details
                        </div>
                        <h4>Device Information & Problem Details</h4>
                        <p class="mb-0 opacity-90">Step 3 of 6: Help us prepare for your emergency repair</p>
                        
                        <div class="progress-bar-container">
                            <div class="custom-progress">
                                <div class="custom-progress-bar"></div>
                            </div>
                            <small class="text-white-50">Step 3: Device Details & Problem Description</small>
                        </div>
                    </div>

                    <!-- Previous Selections Summary -->
                    <div class="selections-summary">
                        <h6 class="mb-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Emergency Service Summary</strong>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-mobile-alt me-2"></i>
                                    <strong>Device:</strong>&nbsp;{{ device_type }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-tools me-2"></i>
                                    <strong>Emergency Service:</strong>&nbsp;{{ service.name }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="opacity-90">
                                    <i class="fas fa-clock me-1"></i>
                                    Estimated Time: {{ service.estimated_time }}min
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="opacity-90">
                                    <i class="fas fa-dollar-sign me-1"></i>
                                    Emergency Deposit: ${{ "%.2f"|format(service.deposit_amount) }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('booking.step4_location') }}" enctype="multipart/form-data" id="detailsForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="device_type" value="{{ device_type }}">
                        <input type="hidden" name="service_id" value="{{ service.id }}">
                        
                        <div class="form-section">
                            <!-- Device Information Section -->
                            <h5 class="section-header">
                                <i class="fas fa-mobile-alt me-2"></i>Emergency Device Information
                            </h5>
                            
                            <div class="row">
                                <!-- Device Model -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="device_model" class="form-label">
                                            <i class="fas fa-info-circle me-1"></i>Device Model *
                                        </label>
                                        {% if device_type == 'iPhone' %}
                                            <select class="form-select" id="device_model" name="device_model" required>
                                                <option value="">Select iPhone Model</option>
                                                <option value="iPhone 15 Pro Max">iPhone 15 Pro Max</option>
                                                <option value="iPhone 15 Pro">iPhone 15 Pro</option>
                                                <option value="iPhone 15 Plus">iPhone 15 Plus</option>
                                                <option value="iPhone 15">iPhone 15</option>
                                                <option value="iPhone 14 Pro Max">iPhone 14 Pro Max</option>
                                                <option value="iPhone 14 Pro">iPhone 14 Pro</option>
                                                <option value="iPhone 14 Plus">iPhone 14 Plus</option>
                                                <option value="iPhone 14">iPhone 14</option>
                                                <option value="iPhone 13 Pro Max">iPhone 13 Pro Max</option>
                                                <option value="iPhone 13 Pro">iPhone 13 Pro</option>
                                                <option value="iPhone 13 Mini">iPhone 13 Mini</option>
                                                <option value="iPhone 13">iPhone 13</option>
                                                <option value="iPhone 12 Pro Max">iPhone 12 Pro Max</option>
                                                <option value="iPhone 12 Pro">iPhone 12 Pro</option>
                                                <option value="iPhone 12 Mini">iPhone 12 Mini</option>
                                                <option value="iPhone 12">iPhone 12</option>
                                                <option value="iPhone 11 Pro Max">iPhone 11 Pro Max</option>
                                                <option value="iPhone 11 Pro">iPhone 11 Pro</option>
                                                <option value="iPhone 11">iPhone 11</option>
                                                <option value="iPhone XS Max">iPhone XS Max</option>
                                                <option value="iPhone XS">iPhone XS</option>
                                                <option value="iPhone XR">iPhone XR</option>
                                                <option value="iPhone X">iPhone X</option>
                                                <option value="iPhone 8 Plus">iPhone 8 Plus</option>
                                                <option value="iPhone 8">iPhone 8</option>
                                                <option value="iPhone 7 Plus">iPhone 7 Plus</option>
                                                <option value="iPhone 7">iPhone 7</option>
                                                <option value="iPhone 6s Plus">iPhone 6s Plus</option>
                                                <option value="iPhone 6s">iPhone 6s</option>
                                                <option value="iPhone 6 Plus">iPhone 6 Plus</option>
                                                <option value="iPhone 6">iPhone 6</option>
                                            </select>
                                        {% elif device_type == 'Samsung' %}
                                            <select class="form-select" id="device_model" name="device_model" required>
                                                <option value="">Select Samsung Model</option>
                                                <option value="Galaxy S24 Ultra">Galaxy S24 Ultra</option>
                                                <option value="Galaxy S24+">Galaxy S24+</option>
                                                <option value="Galaxy S24">Galaxy S24</option>
                                                <option value="Galaxy S23 Ultra">Galaxy S23 Ultra</option>
                                                <option value="Galaxy S23+">Galaxy S23+</option>
                                                <option value="Galaxy S23">Galaxy S23</option>
                                                <option value="Galaxy S22 Ultra">Galaxy S22 Ultra</option>
                                                <option value="Galaxy S22+">Galaxy S22+</option>
                                                <option value="Galaxy S22">Galaxy S22</option>
                                                <option value="Galaxy S21 Ultra">Galaxy S21 Ultra</option>
                                                <option value="Galaxy S21+">Galaxy S21+</option>
                                                <option value="Galaxy S21">Galaxy S21</option>
                                                <option value="Galaxy Note 20 Ultra">Galaxy Note 20 Ultra</option>
                                                <option value="Galaxy Note 20">Galaxy Note 20</option>
                                                <option value="Galaxy Note 10+">Galaxy Note 10+</option>
                                                <option value="Galaxy Note 10">Galaxy Note 10</option>
                                                <option value="Galaxy A54">Galaxy A54</option>
                                                <option value="Galaxy A34">Galaxy A34</option>
                                                <option value="Galaxy A24">Galaxy A24</option>
                                                <option value="Galaxy A14">Galaxy A14</option>
                                                <option value="Other Samsung Model">Other Samsung Model</option>
                                            </select>
                                        {% else %}
                                            <input type="text" class="form-control" id="device_model" name="device_model" 
                                                   placeholder="e.g. Google Pixel 8, OnePlus 12, etc." required>
                                        {% endif %}
                                        <div class="form-text">Select your exact device model for emergency repair preparation</div>
                                    </div>
                                </div>
                                
                                <!-- Storage Capacity -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="storage_capacity" class="form-label">
                                            <i class="fas fa-hdd me-1"></i>Storage Capacity
                                        </label>
                                        <select class="form-select" id="storage_capacity" name="storage_capacity">
                                            <option value="">Unknown/Not Sure</option>
                                            <option value="64GB">64GB</option>
                                            <option value="128GB">128GB</option>
                                            <option value="256GB">256GB</option>
                                            <option value="512GB">512GB</option>
                                            <option value="1TB">1TB</option>
                                            <option value="2TB">2TB</option>
                                        </select>
                                        <div class="form-text">Check in Settings > General > About if unsure</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <!-- Device Color -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="device_color" class="form-label">
                                            <i class="fas fa-palette me-1"></i>Device Color
                                        </label>
                                        <input type="text" class="form-control" id="device_color" name="device_color" 
                                               placeholder="e.g. Space Gray, Gold, Blue, etc.">
                                        <div class="form-text">Helps us identify your device during emergency service</div>
                                    </div>
                                </div>
                                
                                <!-- Purchase Date -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="purchase_date" class="form-label">
                                            <i class="fas fa-calendar me-1"></i>Approximate Purchase Date
                                        </label>
                                        <input type="month" class="form-control" id="purchase_date" name="purchase_date">
                                        <div class="form-text">Helps assess warranty status and part availability</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Pricing Section -->
                            <div id="dynamicPricingSection" style="display: none;" class="mb-4">
                                <h5 class="section-header">
                                    <i class="fas fa-calculator me-2"></i>Service Pricing for Your Device
                                </h5>
                                
                                <div class="pricing-card">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-3">
                                                <i class="fas fa-tag me-2"></i>
                                                Available Service Options
                                            </h6>
                                            
                                            <!-- Service Selection with Parts Options -->
                                            <div id="serviceOptions" class="service-options">
                                                <!-- Dynamic content will be loaded here -->
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="pricing-summary">
                                                <h6 class="mb-3">
                                                    <i class="fas fa-receipt me-2"></i>
                                                    Price Summary
                                                </h6>
                                                
                                                <div class="price-breakdown">
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Service Price:</span>
                                                        <strong id="servicePrice">$0.00</strong>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Emergency Deposit:</span>
                                                        <strong class="text-success" id="depositAmount">$15.00</strong>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Tax (estimated):</span>
                                                        <strong id="taxAmount">$0.00</strong>
                                                    </div>
                                                    <hr>
                                                    <div class="d-flex justify-content-between">
                                                        <span><strong>Total Estimate:</strong></span>
                                                        <strong class="text-primary" id="totalPrice">$15.00</strong>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Final price confirmed after device inspection
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Emergency Problem Description Section -->
                            <h5 class="section-header mt-4">
                                <i class="fas fa-search me-2"></i>Emergency Problem Description
                            </h5>
                            
                            <div class="emergency-info">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Emergency Diagnostic Help:</strong> The more details you provide, the better we can prepare for your emergency repair and potentially resolve the issue faster.
                            </div>

                            <!-- Issue Description Text -->
                            <div class="mb-4">
                                <label for="issue_description" class="form-label">
                                    <i class="fas fa-comment-alt me-1"></i>Describe the Problem *
                                </label>
                                <textarea class="form-control" id="issue_description" name="issue_description" rows="4" 
                                          placeholder="Please describe what happened to your device, when the problem started, and any symptoms you've noticed..." required></textarea>
                                <div class="form-text">
                                    Include details like: When did it start? What were you doing? Any error messages? Physical damage visible?
                                </div>
                            </div>

                            <!-- Photo Upload Section -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-camera me-1"></i>Emergency Diagnostic Photos (Optional)
                                </label>
                                <div class="photo-upload-area" onclick="document.getElementById('damage_photos').click()">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--navy); margin-bottom: 1rem;"></i>
                                    <h6>Upload Photos of Damage or Issue</h6>
                                    <p class="text-muted mb-0">
                                        Click here or drag photos to help our emergency technicians prepare<br>
                                        <small>Supports: JPG, PNG, HEIC (Max 10MB each, up to 5 photos)</small>
                                    </p>
                                </div>
                                <input type="file" id="damage_photos" name="damage_photos" multiple 
                                       accept="image/*,.heic" style="display: none;" onchange="handlePhotoUpload(this)">
                                <div id="photoPreview" class="mt-3"></div>
                            </div>

                            <!-- Previous Attempts -->
                            <div class="mb-4">
                                <label for="previous_attempts" class="form-label">
                                    <i class="fas fa-history me-1"></i>Previous Repair Attempts
                                </label>
                                <textarea class="form-control" id="previous_attempts" name="previous_attempts" rows="2" 
                                          placeholder="Have you tried any DIY fixes or taken this to another repair shop? Let us know what was attempted..."></textarea>
                                <div class="form-text">This helps us avoid duplicate efforts and understand the device's history</div>
                            </div>
                        </div>
                        
                        <div class="step-navigation">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('booking.step2_service', device_type=device_type) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Service Selection
                                </a>
                                
                                <div class="text-center">
                                    <small class="text-muted">Emergency diagnostic information</small>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    Continue to Location <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Emergency Tips -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    Emergency Diagnostic Tips
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-camera text-primary me-2"></i>
                                        <strong>Photos Help:</strong> Clear images of damage speed up diagnosis
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-list text-primary me-2"></i>
                                        <strong>Be Specific:</strong> Exact symptoms help us bring right parts
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-clock text-primary me-2"></i>
                                        <strong>Timeline:</strong> When the problem started affects repair approach
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-shield-alt me-2 text-success"></i>
                                    Emergency Service Preparation
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-tools text-success me-2"></i>
                                        <strong>Tools Ready:</strong> We bring everything needed for your repair
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-database text-success me-2"></i>
                                        <strong>Data Safety:</strong> Your information is always protected
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-stopwatch text-success me-2"></i>
                                        <strong>Quick Service:</strong> Emergency response within hours
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deviceModelSelect = document.getElementById('device_model');
    const deviceType = '{{ service.device_type if service else "iPhone" }}';
    const serviceId = '{{ service.id }}';
    const selectedServiceType = '{{ service.name }}'; // e.g., "Screen Replacement"
    
    let currentDevicePricing = null;
    let selectedServiceOption = null;
    let taxRate = 0.1025; // Default IL tax rate (10.25%)
    
    // Listen for device model changes
    deviceModelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        if (selectedModel) {
            loadDevicePricing(deviceType, selectedModel);
        } else {
            hidePricingSection();
        }
    });
    
    // Load device pricing from API
    async function loadDevicePricing(brand, model) {
        try {
            // Ensure we have a valid brand and model
            if (!brand || !model) {
                console.error('Missing brand or model for pricing lookup');
                hidePricingSection();
                return;
            }
            
            // URL encode the parameters to handle special characters
            const encodedBrand = encodeURIComponent(brand);
            const encodedModel = encodeURIComponent(model);
            const apiUrl = `/booking/api/device-pricing/${encodedBrand}/${encodedModel}`;
            
            console.log('Loading pricing from:', apiUrl);
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.pricing) {
                currentDevicePricing = data.pricing;
                displayPricingOptions();
            } else {
                console.log('No specific pricing found for this device, using default service pricing');
                hidePricingSection();
            }
        } catch (error) {
            console.error('Error loading device pricing:', error);
            hidePricingSection();
        }
    }
    
    // Display pricing options for the device
    function displayPricingOptions() {
        const pricingSection = document.getElementById('dynamicPricingSection');
        const serviceOptionsContainer = document.getElementById('serviceOptions');
        
        if (!currentDevicePricing || !currentDevicePricing.available_services) {
            hidePricingSection();
            return;
        }
        
        // Filter services based on selected service type
        const relevantServices = currentDevicePricing.available_services.filter(service => {
            if (selectedServiceType.includes('Screen')) {
                return service.category === 'Screen';
            } else if (selectedServiceType.includes('Battery')) {
                return service.category === 'Battery';
            } else if (selectedServiceType.includes('Diagnostic')) {
                return service.category === 'Diagnostic';
            }
            return true; // Show all for generic services
        });
        
        if (relevantServices.length === 0) {
            hidePricingSection();
            return;
        }
        
        // Group services by type (Original vs AFM)
        const groupedServices = {};
        relevantServices.forEach(service => {
            const baseType = service.type.replace('_original', '').replace('_afm', '');
            if (!groupedServices[baseType]) {
                groupedServices[baseType] = {
                    name: service.name.replace(' Original', '').replace(' After Market', ''),
                    category: service.category,
                    options: []
                };
            }
            groupedServices[baseType].options.push(service);
        });
        
        // Generate HTML for service options
        let optionsHTML = '';
        Object.keys(groupedServices).forEach(serviceType => {
            const serviceGroup = groupedServices[serviceType];
            
            optionsHTML += `
                <div class="service-option" data-service-type="${serviceType}">
                    <h6 class="mb-3">${serviceGroup.name}</h6>
                    <div class="parts-options">
                        ${serviceGroup.options.map(option => `
                            <div class="parts-option" 
                                 data-service-id="${option.type}" 
                                 data-price="${option.price}"
                                 onclick="selectServiceOption('${option.type}', ${option.price}, '${option.name}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="parts-badge ${option.type.includes('afm') ? 'afm' : ''}">
                                                ${option.type.includes('afm') ? 'AFM' : 'OG'}
                                            </span>
                                            <span class="ms-2">${option.name}</span>
                                        </div>
                                        ${option.type.includes('afm') ? 
                                            '<small class="text-muted">After Market - Quality alternative</small>' : 
                                            '<small class="text-muted">Original - Manufacturer quality</small>'
                                        }
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-primary">$${option.price.toFixed(2)}</strong>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        serviceOptionsContainer.innerHTML = optionsHTML;
        pricingSection.style.display = 'block';
        
        // Pre-select first available option
        const firstOption = relevantServices[0];
        if (firstOption) {
            selectServiceOption(firstOption.type, firstOption.price, firstOption.name);
        }
    }
    
    // Select a service option
    window.selectServiceOption = function(serviceId, price, name) {
        // Remove previous selections
        document.querySelectorAll('.parts-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Add selection to clicked option
        document.querySelector(`[data-service-id="${serviceId}"]`).classList.add('selected');
        
        selectedServiceOption = {
            id: serviceId,
            price: price,
            name: name
        };
        
        updatePricingSummary();
        
        // Show AFM disclaimer if after market selected
        if (serviceId.includes('afm')) {
            showAfmDisclaimer();
        }
    };
    
    // Update pricing summary
    function updatePricingSummary() {
        if (!selectedServiceOption) return;
        
        const servicePrice = selectedServiceOption.price;
        const depositAmount = 15.00; // Fixed deposit
        const taxAmount = servicePrice * taxRate;
        const totalPrice = servicePrice + depositAmount + taxAmount;
        
        // Update display
        document.getElementById('servicePrice').textContent = `$${servicePrice.toFixed(2)}`;
        document.getElementById('depositAmount').textContent = `$${depositAmount.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
        document.getElementById('totalPrice').textContent = `$${totalPrice.toFixed(2)}`;
    }
    
    // Hide pricing section
    function hidePricingSection() {
        document.getElementById('dynamicPricingSection').style.display = 'none';
        selectedServiceOption = null;
    }
    
    // Show AFM disclaimer modal
    function showAfmDisclaimer() {
        if (document.getElementById('afmDisclaimerModal')) return; // Already exists
        
        const modalHTML = `
            <div class="modal fade" id="afmDisclaimerModal" tabindex="-1" aria-labelledby="afmDisclaimerModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header" style="background: #f59e0b; color: white;">
                            <h5 class="modal-title" id="afmDisclaimerModalLabel">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                After Market Parts Notice
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <h6 class="fw-bold mb-3">Important Information About After Market (AFM) Parts</h6>
                                <div class="alert alert-warning">
                                    <ul class="mb-0">
                                        <li><strong>No Brand Logo:</strong> AFM parts do not include manufacturer logos or branding</li>
                                        <li><strong>Different Materials:</strong> May use alternative materials that differ from original specifications</li>
                                        <li><strong>Quality Variance:</strong> While functional, quality may not match original manufacturer standards</li>
                                        <li><strong>Warranty Limitations:</strong> Shorter warranty period compared to original parts</li>
                                    </ul>
                                </div>
                                <p class="mb-0">
                                    <strong>Cost Savings:</strong> AFM parts offer significant cost savings while maintaining basic functionality. 
                                    Choose original parts if you prioritize exact manufacturer specifications.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">I Understand</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('afmDisclaimerModal'));
        modal.show();
    }
    
    // Photo upload handling
    window.handlePhotoUpload = function(input) {
        const files = input.files;
        const previewContainer = document.getElementById('photoPreview');
        
        // Clear previous previews
        previewContainer.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewHTML = `
                    <div class="photo-preview-item d-inline-block me-2 mb-2">
                        <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div class="small text-muted mt-1">${file.name}</div>
                    </div>
                `;
                previewContainer.insertAdjacentHTML('beforeend', previewHTML);
            };
            reader.readAsDataURL(file);
        });
    };
    
    // Form submission - include selected pricing in form data
    document.getElementById('detailsForm').addEventListener('submit', function(e) {
        if (selectedServiceOption) {
            // Add hidden fields for selected pricing
            const serviceIdField = document.createElement('input');
            serviceIdField.type = 'hidden';
            serviceIdField.name = 'selected_service_option';
            serviceIdField.value = selectedServiceOption.id;
            this.appendChild(serviceIdField);
            
            const servicePriceField = document.createElement('input');
            servicePriceField.type = 'hidden';
            servicePriceField.name = 'selected_service_price';
            servicePriceField.value = selectedServiceOption.price;
            this.appendChild(servicePriceField);
        }
    });
});
</script>
{% endblock %} 