{% extends "base.html" %}

{% block title %}Emergency Payment & Confirmation - Step 6: Complete Booking - Fixbulance{% endblock %}

{% block styles %}
<style>
    .booking-container {
        min-height: 70vh;
        background: linear-gradient(135deg, rgba(227, 232, 216, 0.1) 0%, rgba(30, 58, 95, 0.05) 100%);
        padding: 3rem 0;
    }
    
    .booking-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
    }
    
    .booking-header {
        background: linear-gradient(135deg, var(--navy) 0%, var(--light-navy) 100%);
        color: var(--white);
        padding: 2rem;
        text-align: center;
        border: none;
    }
    
    .booking-header h4 {
        color: var(--white);
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .emergency-badge {
        background-color: var(--red);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    
    .progress-bar-container {
        margin: 2rem 0;
    }
    
    .custom-progress {
        height: 8px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .custom-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--red), #ff4757);
        width: 100%; /* 6/6 steps */
        transition: width 0.3s ease;
    }
    
    .order-summary {
        background: linear-gradient(135deg, #10b981, #059669);
        color: var(--white);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        padding: 2.5rem;
    }
    
    .section-header {
        color: var(--navy);
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light-gray);
    }
    
    .form-label {
        font-weight: 600;
        color: var(--dark-navy);
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--navy);
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .payment-method {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
        background: var(--white);
    }
    
    .payment-method:hover {
        border-color: var(--navy);
        box-shadow: 0 8px 25px rgba(30, 58, 95, 0.15);
    }
    
    .payment-method.selected {
        border-color: var(--red);
        background: rgba(220, 38, 38, 0.05);
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .emergency-guarantee {
        background: rgba(220, 38, 38, 0.1);
        border-left: 4px solid var(--red);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .security-info {
        background: var(--light-gray);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .step-navigation {
        padding: 1.5rem 2.5rem;
        background: var(--light-gray);
        border-top: 1px solid #e2e8f0;
    }
    
    .order-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .order-line:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        padding-top: 1rem;
        margin-top: 0.5rem;
        border-top: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    @media (max-width: 768px) {
        .booking-container {
            padding: 1rem 0;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .step-navigation {
            padding: 1rem 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="booking-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card booking-card">
                    <div class="card-header booking-header">
                        <div class="emergency-badge">
                            <i class="fas fa-ambulance me-1"></i>
                            Emergency Booking Confirmation
                        </div>
                        <h4>Complete Your Emergency Repair</h4>
                        <p class="mb-0 opacity-90">Step 6 of 6: Secure your emergency appointment with $15 deposit</p>
                        
                        <div class="progress-bar-container">
                            <div class="custom-progress">
                                <div class="custom-progress-bar"></div>
                            </div>
                            <small class="text-white-50">Step 6: Payment & Booking Confirmation</small>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary">
                        <h5 class="mb-3">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <strong>Emergency Service Order Summary</strong>
                        </h5>
                        
                        <div class="order-line">
                            <span><i class="fas fa-mobile-alt me-2"></i>Device:</span>
                            <strong>{{ device_type }} {{ device_model }}</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-tools me-2"></i>Service:</span>
                            <strong>{{ service.name }}</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-calendar me-2"></i>Date & Time:</span>
                            <strong>{{ appointment_date_formatted }} at {{ appointment_time_formatted }}</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-map-marker-alt me-2"></i>Location:</span>
                            <strong>{{ location_summary }}</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-clock me-2"></i>Estimated Time:</span>
                            <strong>{{ service.estimated_time }} minutes</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-dollar-sign me-2"></i>Service Cost:</span>
                            <strong>${{ service.price }}</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-credit-card me-2"></i>Deposit Required:</span>
                            <strong>$15.00</strong>
                        </div>
                        
                        <div class="order-line">
                            <span><i class="fas fa-calculator me-2"></i>Total Due Now:</span>
                            <strong>$15.00</strong>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('booking.confirm_booking') }}" id="paymentForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="booking_data" value="{{ booking_data }}">
                        <input type="hidden" name="payment_method" id="selectedPaymentMethod">
                        
                        <div class="form-section">
                            <!-- Emergency Guarantee -->
                            <div class="emergency-guarantee">
                                <i class="fas fa-shield-alt me-2"></i>
                                <strong>Emergency Service Guarantee:</strong> Professional repair or no charge. 
                                If we can't fix your device, you pay nothing beyond the $15 deposit.
                            </div>

                            <!-- Stripe Payment Integration -->
                            <h5 class="section-header">
                                <i class="fas fa-credit-card me-2"></i>Secure Payment - $15 Deposit
                            </h5>
                            
                            <!-- Payment Methods Available -->
                            <div class="payment-methods-available mb-4">
                                <div class="row text-center">
                                    <div class="col-md-3 col-6">
                                        <div class="payment-option">
                                            <i class="fas fa-credit-card text-primary" style="font-size: 2rem;"></i>
                                            <small class="d-block mt-1">Cards</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="payment-option">
                                            <i class="fab fa-apple-pay text-primary" style="font-size: 2rem;"></i>
                                            <small class="d-block mt-1">Apple Pay</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="payment-option">
                                            <i class="fab fa-google-pay text-primary" style="font-size: 2rem;"></i>
                                            <small class="d-block mt-1">Google Pay</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="payment-option">
                                            <i class="fab fa-paypal text-primary" style="font-size: 2rem;"></i>
                                            <small class="d-block mt-1">PayPal</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stripe Payment Element Container -->
                            <div id="stripePaymentContainer">
                                <div class="payment-element-wrapper">
                                    <label class="form-label">
                                        <i class="fas fa-shield-alt me-1 text-success"></i>
                                        Payment Information
                                    </label>
                                    <div id="payment-element" class="stripe-payment-element">
                                        <!-- Stripe Elements will be mounted here -->
                                    </div>
                                    <div id="payment-element-errors" role="alert" class="mt-2"></div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <h5 class="section-header mt-4">
                                <i class="fas fa-user me-2"></i>Emergency Contact Information
                            </h5>
                            
                            <div class="row">
                                <!-- Name -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customer_name" class="form-label">
                                            <i class="fas fa-user me-1"></i>Full Name *
                                        </label>
                                        <input type="text" class="form-control" id="customer_name" name="customer_name" 
                                               placeholder="John Doe" required>
                                    </div>
                                </div>
                                
                                <!-- Phone -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customer_phone" class="form-label">
                                            <i class="fas fa-phone me-1"></i>Phone Number *
                                        </label>
                                        <input type="tel" class="form-control" id="customer_phone" name="customer_phone" 
                                               placeholder="(708) 555-0123" required>
                                        <div class="form-text">For appointment confirmation and updates</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Email -->
                            <div class="mb-3">
                                <label for="customer_email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email" 
                                       placeholder="john@example.com" required>
                                <div class="form-text">We'll send your booking confirmation and receipt here</div>
                            </div>

                            <!-- Security Information -->
                            <div class="security-info">
                                <h6 class="mb-2">
                                    <i class="fas fa-shield-alt me-2 text-success"></i>
                                    <strong>Secure Payment Processing</strong>
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-1">
                                                <i class="fas fa-lock text-success me-2"></i>
                                                SSL encrypted payment processing
                                            </li>
                                            <li class="mb-1">
                                                <i class="fas fa-shield-alt text-success me-2"></i>
                                                PCI DSS compliant security
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-1">
                                                <i class="fas fa-undo text-success me-2"></i>
                                                100% refund guarantee
                                            </li>
                                            <li class="mb-1">
                                                <i class="fas fa-phone text-success me-2"></i>
                                                24/7 customer support
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-navigation">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('booking.step5_schedule') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Scheduling
                                </a>
                                
                                <div class="text-center">
                                    <small class="text-muted">Service waiver required before payment</small>
                                </div>
                                
                                <a href="{{ url_for('booking.step5_5_waiver') }}" class="btn btn-warning btn-lg">
                                    <i class="fas fa-file-signature me-2"></i>Continue to Service Waiver
                                </a>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Payment Information -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Deposit Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-dollar-sign text-primary me-2"></i>
                                        <strong>$15 deposit</strong> secures your appointment
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-calculator text-primary me-2"></i>
                                        <strong>Balance due</strong> at time of service
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-undo text-primary me-2"></i>
                                        <strong>Full refund</strong> if repair not completed
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock me-2 text-warning"></i>
                                    What Happens Next
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-check text-warning me-2"></i>
                                        <strong>Instant confirmation</strong> via email & SMS
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-phone text-warning me-2"></i>
                                        <strong>Confirmation call</strong> within 30 minutes
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-ambulance text-warning me-2"></i>
                                        <strong>Van arrives</strong> at scheduled time
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-headset me-2 text-success"></i>
                                    Need Help?
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <strong>Emergency Hotline:</strong> (708) 971-4053
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-envelope text-success me-2"></i>
                                        <strong>Email:</strong> support@fixbulance.com
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Stripe.js Library -->
<script src="https://js.stripe.com/v3/"></script>

<style>
.payment-option {
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.payment-option:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.stripe-payment-element {
    padding: 15px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    background: white;
    margin-top: 8px;
}

.payment-element-wrapper {
    margin-bottom: 20px;
}

#payment-element-errors {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
}

/* Stripe Elements styling */
.StripeElement {
    box-sizing: border-box;
    height: 40px;
    padding: 10px 12px;
    border: 1px solid transparent;
    border-radius: 4px;
    background-color: white;
    box-shadow: 0 1px 3px 0 #e6ebf1;
    transition: box-shadow 150ms ease;
}

.StripeElement--focus {
    box-shadow: 0 1px 3px 0 #cfd7df;
}

.StripeElement--invalid {
    border-color: #fa755a;
}

.StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get form elements
    const confirmBtn = document.getElementById('confirmBtn');
    const paymentForm = document.getElementById('paymentForm');
    const paymentElement = document.getElementById('payment-element');
    
    // Create a functional payment form for local testing
    paymentElement.innerHTML = `
        <div class="payment-form-container">
            <!-- Payment Method Tabs -->
            <div class="payment-tabs mb-3">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="paymentMethod" id="cardMethod" value="card" checked>
                    <label class="btn btn-outline-primary" for="cardMethod">
                        <i class="fas fa-credit-card me-1"></i> Card
                    </label>
                    
                    <input type="radio" class="btn-check" name="paymentMethod" id="appleMethod" value="apple">
                    <label class="btn btn-outline-primary" for="appleMethod">
                        <i class="fab fa-apple-pay me-1"></i> Apple Pay
                    </label>
                    
                    <input type="radio" class="btn-check" name="paymentMethod" id="googleMethod" value="google">
                    <label class="btn btn-outline-primary" for="googleMethod">
                        <i class="fab fa-google-pay me-1"></i> Google Pay
                    </label>
                    
                    <input type="radio" class="btn-check" name="paymentMethod" id="paypalMethod" value="paypal">
                    <label class="btn btn-outline-primary" for="paypalMethod">
                        <i class="fab fa-paypal me-1"></i> PayPal
                    </label>
                </div>
            </div>

            <!-- Card Payment Form -->
            <div id="cardPaymentSection" class="payment-section">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="cardNumber" class="form-label">
                            <i class="fas fa-credit-card me-1"></i> Card Number *
                        </label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        <div class="form-text">Enter your 16-digit card number</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="cardCvv" class="form-label">
                            <i class="fas fa-lock me-1"></i> CVV *
                        </label>
                        <input type="text" class="form-control" id="cardCvv" placeholder="123" maxlength="4">
                        <div class="form-text">3-4 digit code</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cardExpiry" class="form-label">
                            <i class="fas fa-calendar me-1"></i> Expiry Date *
                        </label>
                        <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cardName" class="form-label">
                            <i class="fas fa-user me-1"></i> Cardholder Name *
                        </label>
                        <input type="text" class="form-control" id="cardName" placeholder="John Doe">
                    </div>
                </div>
            </div>

            <!-- Alternative Payment Methods -->
            <div id="applePaySection" class="payment-section" style="display: none;">
                <div class="text-center p-4">
                    <i class="fab fa-apple-pay" style="font-size: 3rem; color: #000;"></i>
                    <h6 class="mt-2">Apple Pay</h6>
                    <p class="text-muted">Touch ID or Face ID required</p>
                    <button type="button" class="btn btn-dark" id="applePayBtn">
                        <i class="fab fa-apple-pay me-2"></i> Pay with Apple Pay
                    </button>
                </div>
            </div>

            <div id="googlePaySection" class="payment-section" style="display: none;">
                <div class="text-center p-4">
                    <i class="fab fa-google-pay" style="font-size: 3rem; color: #4285f4;"></i>
                    <h6 class="mt-2">Google Pay</h6>
                    <p class="text-muted">Quick and secure payment</p>
                    <button type="button" class="btn btn-primary" id="googlePayBtn">
                        <i class="fab fa-google-pay me-2"></i> Pay with Google Pay
                    </button>
                </div>
            </div>

            <div id="paypalSection" class="payment-section" style="display: none;">
                <div class="text-center p-4">
                    <i class="fab fa-paypal" style="font-size: 3rem; color: #003087;"></i>
                    <h6 class="mt-2">PayPal</h6>
                    <p class="text-muted">Pay with your PayPal account</p>
                    <button type="button" class="btn btn-primary" id="paypalBtn" style="background: #0070ba;">
                        <i class="fab fa-paypal me-2"></i> Pay with PayPal
                    </button>
                </div>
            </div>

            <div class="mt-3 p-2 bg-light rounded text-center">
                <small class="text-success">
                    <i class="fas fa-shield-alt me-1"></i>
                    Secure payment processing powered by Stripe
                </small>
            </div>
        </div>
    `;

    // Payment method switching
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all sections
            document.querySelectorAll('.payment-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const selectedSection = document.getElementById(this.value + 'PaymentSection') || 
                                  document.getElementById(this.value + 'Section');
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            updateConfirmButton();
        });
    });

    // Card number formatting
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        
        if (formattedValue.length > 19) {
            formattedValue = formattedValue.substring(0, 19);
        }
        
        e.target.value = formattedValue;
        updateConfirmButton();
    });

    // CVV formatting
    document.getElementById('cardCvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').substring(0, 4);
        updateConfirmButton();
    });

    // Expiry date formatting
    document.getElementById('cardExpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
        updateConfirmButton();
    });

    // Alternative payment button handlers
    document.getElementById('applePayBtn').addEventListener('click', function() {
        processAlternativePayment('Apple Pay');
    });

    document.getElementById('googlePayBtn').addEventListener('click', function() {
        processAlternativePayment('Google Pay');
    });

    document.getElementById('paypalBtn').addEventListener('click', function() {
        processAlternativePayment('PayPal');
    });

    function processAlternativePayment(method) {
        const confirmBtn = document.getElementById('confirmBtn');
        if (!confirmBtn) return; // Exit if button doesn't exist
        
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing ' + method + '...';
        confirmBtn.disabled = true;
        
        setTimeout(() => {
            if (!confirmBtn) return; // Check again in case element was removed
            
            confirmBtn.innerHTML = '<i class="fas fa-check me-2"></i>Payment Successful!';
            
            const errorElement = document.getElementById('payment-element-errors');
            if (errorElement) {
                errorElement.innerHTML = '<div class="alert alert-success mt-2"><i class="fas fa-check me-2"></i>' + method + ' payment processed successfully!</div>';
            }
            
            setTimeout(() => {
                if (confirmBtn) {
                    alert('Payment successful via ' + method + '! Booking confirmed. (Development simulation)');
                    confirmBtn.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Secure Payment - $15';
                    confirmBtn.disabled = false;
                }
                if (errorElement) {
                    errorElement.innerHTML = '';
                }
            }, 2000);
        }, 1500);
    }
    
    // Phone formatting
    document.getElementById('customer_phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        let formattedValue = '';
        
        if (value.length > 0) {
            formattedValue = '(' + value.substring(0, 3);
        }
        if (value.length >= 4) {
            formattedValue += ') ' + value.substring(3, 6);
        }
        if (value.length >= 7) {
            formattedValue += '-' + value.substring(6, 10);
        }
        
        e.target.value = formattedValue;
        updateConfirmButton();
    });
    
    // Form validation
    function updateConfirmButton() {
        const confirmBtn = document.getElementById('confirmBtn');
        if (!confirmBtn) return; // Exit if button doesn't exist
        
        const nameEl = document.getElementById('customer_name');
        const phoneEl = document.getElementById('customer_phone');
        const emailEl = document.getElementById('customer_email');
        
        if (!nameEl || !phoneEl || !emailEl) return; // Exit if contact fields don't exist
        
        const name = nameEl.value.trim();
        const phone = phoneEl.value.trim();
        const email = emailEl.value.trim();
        
        const contactValid = name.length > 0 && phone.length >= 10 && 
                           email.includes('@') && email.includes('.');
        
        // Check payment method validation
        const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
        let paymentValid = true;
        
        if (selectedPayment && selectedPayment.value === 'card') {
            const cardNumberEl = document.getElementById('cardNumber');
            const cardCvvEl = document.getElementById('cardCvv');
            const cardExpiryEl = document.getElementById('cardExpiry');
            const cardNameEl = document.getElementById('cardName');
            
            if (cardNumberEl && cardCvvEl && cardExpiryEl && cardNameEl) {
                const cardNumber = cardNumberEl.value.replace(/\s/g, '');
                const cardCvv = cardCvvEl.value;
                const cardExpiry = cardExpiryEl.value;
                const cardName = cardNameEl.value.trim();
                
                paymentValid = cardNumber.length >= 13 && 
                              cardCvv.length >= 3 && 
                              cardExpiry.length === 5 && 
                              cardName.length > 0;
            }
        }
        
        const allValid = contactValid && paymentValid;
        
        if (allValid) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Secure Payment - $15';
        } else {
            confirmBtn.disabled = true;
            if (!contactValid) {
                confirmBtn.innerHTML = '<i class="fas fa-clock me-2"></i>Complete Contact Info';
            } else if (!paymentValid) {
                confirmBtn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Complete Payment Info';
            }
        }
    }
    
    // Add event listeners to contact form fields
    document.querySelectorAll('#customer_name, #customer_phone, #customer_email').forEach(field => {
        field.addEventListener('input', updateConfirmButton);
        field.addEventListener('change', updateConfirmButton);
    });
    
    // Add event listeners to card input fields  
    document.querySelectorAll('#cardName').forEach(field => {
        field.addEventListener('input', updateConfirmButton);
        field.addEventListener('change', updateConfirmButton);
    });
    
    // Handle form submission
    paymentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const confirmBtn = document.getElementById('confirmBtn');
        if (!confirmBtn) return; // Exit if button doesn't exist
        
        const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
        const paymentMethod = selectedPayment ? selectedPayment.value : 'card';
        
        // Show loading state
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Payment...';
        confirmBtn.disabled = true;
        
        // For local development, simulate payment processing
        setTimeout(() => {
            if (!confirmBtn) return; // Check again
            
            confirmBtn.innerHTML = '<i class="fas fa-check me-2"></i>Payment Successful!';
            
            // Show success message
            const errorElement = document.getElementById('payment-element-errors');
            const methodText = paymentMethod === 'card' ? 'Card' : 
                              paymentMethod === 'apple' ? 'Apple Pay' :
                              paymentMethod === 'google' ? 'Google Pay' :
                              paymentMethod === 'paypal' ? 'PayPal' : 'Card';
            
            if (errorElement) {
                errorElement.innerHTML = '<div class="alert alert-success mt-2"><i class="fas fa-check me-2"></i>' + methodText + ' payment processed successfully! Redirecting to confirmation...</div>';
            }
            
            // Simulate redirect after 2 seconds
            setTimeout(() => {
                // In production, this would redirect to the actual confirmation page
                alert('Payment successful via ' + methodText + '! Booking confirmed. (Development simulation)');
                if (confirmBtn) {
                    confirmBtn.innerHTML = '<i class="fas fa-shield-alt me-2"></i>Secure Payment - $15';
                    confirmBtn.disabled = false;
                }
                if (errorElement) {
                    errorElement.innerHTML = '';
                }
            }, 2000);
        }, 1500);
    });
    
    // Initial button state check
    updateConfirmButton();
});
</script>
{% endblock %} 